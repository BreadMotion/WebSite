---
title: "自作Discord Botを公開したらスパムに悪用された話"
date: 2024-10-26
category: Discord
description: "自作したDiscord Botを公開したところ、スパムの踏み台にされてしまいました。原因となったアーキテクチャの設計ミスと、今後のセキュリティ対策についてまとめます。"
tags: ["discord", "nodejs", "security", "反省"]
thumbnail: data:image/png;base64,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
---

こんにちは、パン君です。

今回は個人で運用していた **Discord Botを公開したら大失敗した** という話になります。

先日、僕が運営しているゲーム開発サーバーで事件が起きました。
なんと自作ボットが乗っ取られたかのように、**全く関係ないDiscordサーバーの招待URLをひたすら連投し始めた**んです。
原因は僕が作ったボットの**アーキテクチャに潜んでいた致命的な設計ミス**でした。

今回は自戒を込めて、僕がやらかしたミスとその対策を全部ここに書き残しておこうと思います。

## 何が問題だったのか？

原因は大きく分けて2つありました。

### 1. どのサーバーからでも、他のサーバーにコマンドが実行できた

詳細は[こちらの記事](https://breadmotion.github.io/WebSite/blog/blog_00008.html)でも書いたアーキテクチャが根本的な問題でした。
開発者向けにボットを追加しなくても色々な機能を追加できることを目指した結果、「どのサーバーからでもコマンドを実行できる」という仕様になっていたんです。

**【なぜこれがヤバかったか？】**
この仕様のせいで攻撃者は**自分のサーバーから、僕のゲーム開発サーバーに対してメッセージを送信する**という離れ業が可能になっていました。
つまり、Aサーバーで実行したコマンドが全く無関係なBサーバーで発動してしまう状態だったんです。これがスパムの直接的な原因でした。

普通に考えたらマズいですよね。
ファイルベースでも良いので、サーバー（ギルド）ごとに実行できるコマンドを管理すべきでした。

### 2. 参加サーバーの一覧をリポジトリで公開していた

これも致命的でした。
ボットが参加しているサーバーの情報を `guilds.json` というファイルで管理していたのですが、これを**GitHubの公開リポジトリにアップしてしまっていた**んです。

**【なぜこれがヤバかったか？】**
`guilds.json` には、ボットが参加している全てのサーバーIDがリストアップされていました。
攻撃者はこのリストを手に入れ、標的となるサーバー（僕のゲーム開発サーバー）のIDを特定し、そこに向けてスパムメッセージを送信していたわけです。
個人情報じゃないとはいえ、サーバーIDも立派な機密情報でした...。

## 今後の対策

今回の反省を踏まえて、ボットの仕組みを根本から見直すことにしました。

1.  **Botアプリの再作成 & トークンの完全リセット**
    まずは今のボットアプリを完全に削除して、新しいアプリとして作り直します。トークンをリセットするだけじゃ不十分なので、クリーンな状態から再スタートです。

2.  **ギルドごとの権限管理を徹底**
    コマンドが他のサーバーに影響を与えないように、サーバーID（ギルドID）で完全に処理を分離します。今後はファイルベースのDBで、サーバーごとに許可するコマンドを管理する仕組みを導入します。

3.  **招待方法を「リクエスト制」に変更**
    誰がボットを使っているかを僕が把握できるように、招待は公開制をやめて、僕への直接連絡によるリクエスト制に切り替えます。

4.  **リポジトリのクリーンアップ**
    ソースコードは引き続き公開しますが、`guilds.json`のような機密情報を含んでしまう可能性があるファイルはリポジトリから完全に削除し、`.gitignore`でしっかり管理するようにします。

## まとめ

というわけで、今回は僕の盛大なやらかしについての話でした。
「誰でも使えるように」という手軽さを重視した結果、セキュリティという一番大事な視点が抜け落ちていたなと深く反省しています。

ボットはもっと安全な形に作り直していくので、もし「それでも使ってみたい！」と思ってくれる人がいたら気軽に声をかけてくれると嬉しいです。
