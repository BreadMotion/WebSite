---
title: Discord Bot のアーキテクチャを見直した話
date: 2025-02-01
category: Discord
description: Discord Bot の構成メモ コマンド／イベントをプラグイン的に追加
tags: discord, nodejs, architecture, plugin, tool
thumbnail: data:image/png;base64,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
---

こんにちは、パン君です。

この記事では、個人で運用している **Discord Bot のアーキテクチャをどう組み直したか** をまとめます。

やりたかったことはざっくりいうと、

- コマンドやイベントを「 **ファイルを追加するだけ** 」で拡張できる  
- サーバー上では `pm2` で常駐管理  
- `git pull` ＋シェルスクリプトで **半自動デプロイ**  
- 将来的に「管理用 Web ページ」や「API」とも連携しやすくしておく

という構成です。

---

## 目標と前提

### 目標

1. **Bot 本体をコア／プラグインに分離**
   - コマンドやイベントは「後から足せるモジュール」として扱う。
2. **運用を楽にする**
   - Ubuntu サーバー上で `pm2` にお任せして、SSH を切っても動き続ける。
3. **デプロイをシンプルにする**
   - 管理用リポジトリに push → サーバー側で pull ＋再起動するだけ。

### 前提

- 言語：Node.js（TypeScript も見据えつつ、現在は主に JS）
- ライブラリ：discord.js
- 実行環境：Ubuntu Server + pm2
- 外部アクセス：playit.gg でトンネルを張って、外部から接続可能

---

## ディレクトリ構成

最終的に落ち着いた構成はこんな感じです。

```text
bot-root/
├── Command/        # コマンドモジュール
├── Event/          # イベントハンドラ
├── Data/           # JSON 等の設定・永続データ
├── Class/          # 共通クラス・ヘルパ
├── Shell/          # デプロイ用シェルスクリプト
├── types/          # JSDoc など型関連
├── logs/           # pm2 のログ出力先
├── config.json     # トークンや設定（dotenv でも可）
└── index.js        # エントリポイント（コア）
```

ポイントは **Command / Event / Data を完全に分離** したことです。
- index.js(コア)は「モジュールを読み込んでWiringするだけ」
- コマンドの中身は Command/ 下のJSファイルが担当
- イベントは Event/ 下のJSファイルが担当
という形にすることで、 **Bot本体を触らずに機能追加** ができるようになりました。

## コマンドのプラグイン構造

### コマンドモジュールの形

各コマンドは大体こんな形のJSファイルを１ファイルで持ちます。
```js
// Command/ping.js
/** @type {import('../types').BotCommand} */
module.exports = {
  name: "ping",
  description: "疎通確認用コマンド",
  options: [],
  async execute(interaction, context) {
    const start = Date.now();
    await interaction.reply("Pong!");
    const ms = Date.now() - start;
    console.log(`[ping] latency: ${ms}ms`);
  },
};
```

- name / description / options はそのまま slash command の定義に流用
- execute には interaction と共通の context（設定・ロガーなど）を渡す

### 動的読み込み

コア側では、起動時に Command/ ディレクトリを走査して全部読み込みます。

やっていることはシンプルで、
1. fs.readdirSync("Command") で .js ファイル一覧を取得
2. require して name をキーに Map に登録
3. slash command の登録用に JSON を組み立てる
という流れです。

このおかげで、新しいコマンドを追加するときは
1. Command/ に JS ファイルを作る
2. Git に commit ＋ push
3. サーバーで pull して再起動
だけで済むようになりました。

### イベントハンドラの構造

イベントもコマンドと同じノリでファイルベースにしています。
```js
// Event/ready.js
/** @type {import('../types').BotEvent} */
module.exports = {
  name: "ready",
  once: true,
  execute(client, context) {
    console.log(`[ready] Logged in as ${client.user.tag}`);
  },
};

```
```js
// Event/interactionCreate.js
module.exports = {
  name: "interactionCreate",
  once: false,
  async execute(interaction, context) {
    if (!interaction.isChatInputCommand()) return;

    const command = context.commands.get(interaction.commandName);
    if (!command) return;

    try {
      await command.execute(interaction, context);
    } catch (err) {
      console.error(err);
      if (!interaction.replied) {
        await interaction.reply({
          content: "エラーが発生しました。",
          ephemeral: true,
        });
      }
    }
  },
};
```
コア側では、Event/ を走査して
`client.on(event.name, handler) or client.once(...)`
を自動で登録するだけにしています。

---

## pm2とデプロイフロー

### pm2での常駐

Ubuntu Server 上では pm2 を使って常駐させています。
```bash
pm2 start index.js --name bread-bot
pm2 save
pm2 startup
```
- SSH を切っても Bot は動き続ける
- pm2 logs bread-bot でログ確認
- pm2 restart bread-bot で反映
という基本の運用です。

### デプロイ用スクリプト

デプロイはシンプルに Shell/ に 1 本スクリプトを置きました。
```bash
#!/usr/bin/env bash
set -eu

cd /opt/bread-bot

echo "[deploy] git pull"
git pull origin main

echo "[deploy] npm install"
npm install --production

echo "[deploy] restart pm2"
pm2 restart bread-bot

```
- リポジトリを更新 → サーバー側でこのスクリプト実行
- 将来的には Webhook や CI から叩いてもよい
という形にしています。

---

## これからやりたい拡張

現状でも「コマンドを JS 1 ファイルで追加できる Bot」になりましたが、さらにやりたいのはこのあたりです。

1. **型まわりの強化**
  - TypeScript 化 or JSDoc で interaction / context に型をつける
  - ApplicationCommandOptionData を定義専用のヘルパにまとめる
2. **管理用 Web ページとの連携**
  - Express / Fastify などで API を立てて
  - 「今登録されているコマンド一覧」や「Guild 状態」を Web から確認
3.ログとメトリクス
  - エラーや特定イベントを別チャンネルに送る
  - Cloud 上のログ基盤に送るところまで視野に入れる
  
  ---

## まとめ

- コマンド／イベントを ディレクトリ単位で分割して、Bot 本体は「読み込んで繋ぐだけ」にする
- pm2 と簡単なシェルスクリプトで、運用とデプロイをシンプルにする
- 将来の拡張（Web 管理画面や API）を見据えて、context という共通オブジェクトをコマンドに渡す

こういう形にしたことで、 「1つの巨大な index.js に全部書いてある Discord Bot」
から、だいぶ卒業できた気がします。

同じように Bot を長期運用したい人の参考になれば嬉しいです。

---
